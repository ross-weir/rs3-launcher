#!/bin/sh

CACHE_FOLDER="$HOME/Jagex" # Where to store client cache
USER_FOLDER="$HOME/Jagex" # where to store client settings
PID=$(printf "%X" $$) # Pid to use to identify client instance

# Make the nesessary folders / game client if they don't exist already.
mkdir -p "$USER_FOLDER/launcher" "$CACHE_FOLDER"

client="$USER_FOLDER/launcher/rs2client"
touch "$client"

# Download config
GAME_CONFIG=$(curl -s -L 'http://runescape.com/k=5/jav_config.ws?binaryType=4') 

# Find the latest crc32
LATEST=$(echo "$GAME_CONFIG" | sed -n 's/^download_crc_0=//p')

# Calculate hash of the current game file
CURRENT=$(rhash --printf=%c "$client")

# Check to see if we have the latest version
if [ "$((0x$CURRENT))" != "$LATEST" ] ; then
	# Download file
	CODEBASE=$(echo "$GAME_CONFIG" | sed -n 's/^codebase=//p')
        curl -L -o "$client.lzma" "${CODEBASE}client?binaryType=4&fileName=rs2client&crc=$LATEST"
	# Decompress file
        7z e "$client.lzma" -y
	chmod +x "$client"
	# Check hash of newly downloaded client
	CURRENT=$(rhash --printf=%c "$client")
	if  [ "$((0x$CURRENT))" != "$LATEST" ]; then
                echo 'rs2client was downloaded and extracted incorrectly; exiting...' && exit 1
        fi
fi

PARAMS="$client $(echo "$GAME_CONFIG" | awk -P -F= -v x="\"" '$1=="param" {print x$2x, x$3x}') launcher $PID"
echo $PARAMS

# Launch launcher
echo "$PARAMS" | xargs $(dirname $0)/launcher "$CACHE_FOLDER" "$USER_FOLDER"